<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图书馆勤工助学值班记录器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#4080FF',
                        library: '#3B82F6',    // 书库班颜色
                        circulation: '#10B981', // 流通班颜色
                        clear: '#F97316',       // 清零按钮颜色
                        delete: '#EF4444',      // 删除按钮颜色
                        neutral: '#F8FAFC',
                        card: '#FFFFFF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03)',
                        'card-hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'modal': '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
            .bg-gradient-soft {
                background: linear-gradient(135deg, #f0f9ff 0%, #f8fafc 100%);
            }
            .card-effect {
                transition: all 0.3s ease;
            }
            .card-effect:hover {
                transform: translateY(-3px);
            }
            .student-item {
                transition: all 0.3s ease;
            }
            .modal-effect {
                animation: fadeIn 0.3s ease forwards;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.95); }
                to { opacity: 1; transform: scale(1); }
            }
        }
    </style>
</head>
<body class="bg-gradient-soft min-h-screen font-sans text-gray-800">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 标题区域 -->
        <header class="text-center mb-10 mt-4">
            <div class="inline-block bg-primary/10 rounded-full p-3 mb-4">
                <i class="fa fa-book text-primary text-3xl"></i>
            </div>
            <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-gray-800 mb-2 tracking-tight">图书馆勤工助学值班记录</h1>
            <p class="text-gray-600 max-w-2xl mx-auto">便捷记录和管理学生在书库班和流通班的值班次数，数据自动保存在本地</p>
        </header>

        <!-- 添加人员区域 -->
        <div class="bg-card rounded-xl shadow-card p-6 mb-8 card-effect">
            <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fa fa-user-plus text-primary mr-2"></i>学生管理
            </h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="newPerson" placeholder="输入单个学生姓名" class="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all-300 text-base shadow-sm">
                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <button id="addBtn" class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center transition-all-300 transform hover:scale-105 active:scale-95 shadow-md hover:shadow-lg">
                        <i class="fa fa-plus mr-2"></i>单个添加
                    </button>
                    <button id="batchImportBtn" class="bg-secondary hover:bg-secondary/90 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center transition-all-300 transform hover:scale-105 active:scale-95 shadow-md hover:shadow-lg">
                        <i class="fa fa-upload mr-2"></i>批量导入
                    </button>
                </div>
            </div>
        </div>

        <!-- 操作按钮区域 -->
        <div class="flex justify-end mb-6">
            <button id="showSummaryBtn" class="bg-gray-800 hover:bg-gray-700 text-white px-6 py-2.5 rounded-lg font-medium flex items-center transition-all-300 transform hover:scale-105 active:scale-95 shadow-md">
                <i class="fa fa-list mr-2"></i>显示全部记录
            </button>
        </div>

        <!-- 汇总记录区域（默认隐藏） -->
        <div id="summaryArea" class="bg-card rounded-xl shadow-card p-6 mb-8 hidden card-effect">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-2">
                <h2 class="text-lg font-semibold text-gray-700 flex items-center">
                    <i class="fa fa-table text-primary mr-2"></i>值班记录汇总
                </h2>
                <span id="summaryDate" class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full"></span>
            </div>
            
            <div class="overflow-x-auto rounded-lg border border-gray-100">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">序号</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学生姓名</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">书库班数</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">流通班数</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总次数</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- 汇总内容将通过JS动态生成 -->
                    </tbody>
                    <tfoot class="bg-gray-50">
                        <tr>
                            <td class="py-3 px-6 text-sm font-bold" colspan="2">总计</td>
                            <td class="py-3 px-6 text-sm font-bold text-library" id="summaryTotalLibrary"></td>
                            <td class="py-3 px-6 text-sm font-bold text-circulation" id="summaryTotalCirculation"></td>
                            <td class="py-3 px-6 text-sm font-bold text-primary" id="summaryTotalAll"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- 人员列表区域 -->
        <div class="bg-card rounded-xl shadow-card p-6 mb-8 card-effect">
            <h2 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fa fa-list-alt text-primary mr-2"></i>学生值班列表
                <span class="ml-2 text-sm text-gray-500">(点击刷新图标可清零对应班次)</span>
            </h2>
            <div id="personList" class="space-y-4">
                <!-- 人员记录将通过JavaScript动态添加 -->
                <div class="text-gray-500 text-center py-12" id="emptyState">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                        <i class="fa fa-info-circle text-2xl opacity-30"></i>
                    </div>
                    <p class="mb-2">还没有添加学生</p>
                    <p class="text-sm text-gray-400">请使用「单个添加」或「批量导入」功能添加学生</p>
                </div>
            </div>
        </div>

        <!-- 总计统计区域 -->
        <div class="bg-card rounded-xl shadow-card p-6 card-effect">
            <h2 class="text-lg font-semibold text-gray-700 mb-5 flex items-center">
                <i class="fa fa-bar-chart text-primary mr-2"></i>值班统计
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                <div class="bg-neutral p-5 rounded-lg border border-gray-100">
                    <p class="text-gray-500 text-sm mb-1">书库班总次数</p>
                    <p class="text-3xl font-bold text-library" id="totalLibraryDuties">0</p>
                </div>
                <div class="bg-neutral p-5 rounded-lg border border-gray-100">
                    <p class="text-gray-500 text-sm mb-1">流通班总次数</p>
                    <p class="text-3xl font-bold text-circulation" id="totalCirculationDuties">0</p>
                </div>
                <div class="bg-neutral p-5 rounded-lg border border-gray-100">
                    <p class="text-gray-500 text-sm mb-1">参与学生总数</p>
                    <p class="text-3xl font-bold text-gray-800" id="totalPeople">0</p>
                </div>
            </div>
            <button id="resetBtn" class="mt-5 text-red-500 hover:text-red-700 text-sm font-medium flex items-center transition-all-300 hover:pl-1">
                <i class="fa fa-refresh mr-1"></i> 重置所有记录
            </button>
        </div>

        <!-- 页脚 -->
        <footer class="mt-10 text-center text-gray-500 text-sm pb-6">
            <p>数据自动保存在本地，刷新页面不会丢失</p>
        </footer>
    </div>

    <!-- 批量导入模态框（默认隐藏） -->
    <div id="batchImportModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-card rounded-xl shadow-modal p-6 w-full max-w-2xl modal-effect">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fa fa-upload text-secondary mr-2"></i>批量导入学生
                </h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition-all-300">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- 导入说明 -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4 text-sm text-gray-600">
                <p class="font-medium mb-1">支持以下格式（自动去重）：</p>
                <ul class="list-disc list-inside space-y-1">
                    <li>逗号分隔：张三,李四,王五</li>
                    <li>换行分隔：张三<br>李四<br>王五</li>
                    <li>空格分隔：张三 李四 王五</li>
                    <li>混合分隔：张三,李四 王五<br>赵六</li>
                </ul>
                <p class="mt-2 font-medium">系统会自动处理：</p>
                <ul class="list-disc list-inside space-y-1">
                    <li>导入文本中重复的名字（只保留一个）</li>
                    <li>与系统中已存在的学生重复的名字</li>
                </ul>
            </div>
            
            <!-- 文本输入区域 -->
            <textarea id="batchText" rows="6" placeholder="请粘贴学生姓名（支持多种分隔符）..." class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary/50 focus:border-secondary transition-all-300 mb-4"></textarea>
            
            <!-- 操作按钮 -->
            <div class="flex justify-end gap-3">
                <button id="cancelImportBtn" class="px-6 py-2.5 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all-300">
                    取消
                </button>
                <button id="confirmImportBtn" class="bg-secondary hover:bg-secondary/90 text-white px-6 py-2.5 rounded-lg font-medium transition-all-300 transform hover:scale-105 active:scale-95">
                    <i class="fa fa-check mr-1"></i>确认导入
                </button>
            </div>
            
            <!-- 导入结果提示（默认隐藏） -->
            <div id="importResult" class="mt-4 p-3 rounded-lg hidden"></div>
        </div>
    </div>

    <script>
        // 初始化数据 - 每个人包含书库班和流通班两种计数
        let students = JSON.parse(localStorage.getItem('libraryStudents')) || [];
        
        // DOM元素
        const personList = document.getElementById('personList');
        const newPersonInput = document.getElementById('newPerson');
        const addBtn = document.getElementById('addBtn');
        const batchImportBtn = document.getElementById('batchImportBtn');
        const batchImportModal = document.getElementById('batchImportModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const confirmImportBtn = document.getElementById('confirmImportBtn');
        const batchText = document.getElementById('batchText');
        const importResult = document.getElementById('importResult');
        const showSummaryBtn = document.getElementById('showSummaryBtn');
        const summaryArea = document.getElementById('summaryArea');
        const summaryTableBody = document.getElementById('summaryTableBody');
        const summaryDate = document.getElementById('summaryDate');
        const summaryTotalLibrary = document.getElementById('summaryTotalLibrary');
        const summaryTotalCirculation = document.getElementById('summaryTotalCirculation');
        const summaryTotalAll = document.getElementById('summaryTotalAll');
        const totalLibraryEl = document.getElementById('totalLibraryDuties');
        const totalCirculationEl = document.getElementById('totalCirculationDuties');
        const totalPeopleEl = document.getElementById('totalPeople');
        const emptyState = document.getElementById('emptyState');
        const resetBtn = document.getElementById('resetBtn');

        // 渲染学生列表
        function renderStudents() {
            // 清空列表
            personList.innerHTML = '';
            
            // 检查是否有学生数据
            if (students.length === 0) {
                personList.appendChild(emptyState);
            } else {
                // 添加所有学生
                students.forEach((student, index) => {
                    const studentEl = document.createElement('div');
                    studentEl.className = 'student-item flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border border-gray-100 rounded-lg hover:bg-gray-50 transition-all-300';
                    studentEl.innerHTML = `
                        <div class="flex items-center mb-3 sm:mb-0">
                            <div class="w-9 h-9 bg-primary/10 text-primary rounded-full flex items-center justify-center mr-3">
                                <i class="fa fa-user"></i>
                            </div>
                            <span class="font-medium text-gray-800">${student.name}</span>
                        </div>
                        <div class="flex flex-wrap items-center gap-4 w-full sm:w-auto justify-between sm:justify-end">
                            <!-- 书库班操作区 -->
                            <div class="flex items-center">
                                <span class="text-sm text-gray-600 mr-2">书库班:</span>
                                <span class="bg-library/10 text-library px-3 py-1.5 rounded-full font-semibold min-w-[40px] text-center library-count">
                                    ${student.libraryDuty}
                                </span>
                                <button class="increment-library bg-library hover:bg-library/90 text-white p-2 rounded-full ml-2 transition-all-300 transform hover:scale-110 active:scale-95 shadow-sm" data-index="${index}">
                                    <i class="fa fa-plus"></i>
                                </button>
                                <button class="clear-duty-btn bg-clear/10 text-clear hover:bg-clear/20 p-2 rounded-full ml-2 transition-all-300 shadow-sm" 
                                        data-index="${index}" data-type="library" title="清零书库班次数">
                                    <i class="fa fa-refresh"></i>
                                </button>
                            </div>
                            <!-- 流通班操作区 -->
                            <div class="flex items-center">
                                <span class="text-sm text-gray-600 mr-2">流通班:</span>
                                <span class="bg-circulation/10 text-circulation px-3 py-1.5 rounded-full font-semibold min-w-[40px] text-center circulation-count">
                                    ${student.circulationDuty}
                                </span>
                                <button class="increment-circulation bg-circulation hover:bg-circulation/90 text-white p-2 rounded-full ml-2 transition-all-300 transform hover:scale-110 active:scale-95 shadow-sm" data-index="${index}">
                                    <i class="fa fa-plus"></i>
                                </button>
                                <button class="clear-duty-btn bg-clear/10 text-clear hover:bg-clear/20 p-2 rounded-full ml-2 transition-all-300 shadow-sm" 
                                        data-index="${index}" data-type="circulation" title="清零流通班次数">
                                    <i class="fa fa-refresh"></i>
                                </button>
                            </div>
                            <!-- 删除按钮 -->
                            <button class="delete-btn bg-delete/10 text-delete hover:bg-delete/20 px-4 py-1.5 rounded-lg flex items-center gap-1.5 transition-all-300 shadow-sm" 
                                    data-index="${index}" title="删除该学生所有记录">
                                <i class="fa fa-trash"></i>
                                <span>删除</span>
                            </button>
                        </div>
                    `;
                    personList.appendChild(studentEl);
                });

                // 绑定所有事件监听器
                bindEventListeners();
            }

            // 更新统计信息
            updateStats();
            
            // 保存数据到本地存储
            saveData();
        }

        // 绑定所有交互事件
        function bindEventListeners() {
            // 移除旧的事件监听器（防止重复绑定）
            document.querySelectorAll('.increment-library').forEach(btn => {
                btn.removeEventListener('click', handleLibraryIncrement);
                btn.addEventListener('click', handleLibraryIncrement);
            });

            document.querySelectorAll('.increment-circulation').forEach(btn => {
                btn.removeEventListener('click', handleCirculationIncrement);
                btn.addEventListener('click', handleCirculationIncrement);
            });

            // 班次清零按钮事件绑定
            document.querySelectorAll('.clear-duty-btn').forEach(btn => {
                btn.removeEventListener('click', handleClearDuty);
                btn.addEventListener('click', handleClearDuty);
            });

            // 删除按钮事件绑定
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.removeEventListener('click', handleDelete);
                btn.addEventListener('click', handleDelete);
            });
        }

        // 更新统计信息
        function updateStats() {
            const totalLibrary = students.reduce((sum, student) => sum + student.libraryDuty, 0);
            const totalCirculation = students.reduce((sum, student) => sum + student.circulationDuty, 0);
            
            // 添加数字变化动画
            animateValue(totalLibraryEl, parseInt(totalLibraryEl.textContent), totalLibrary, 300);
            animateValue(totalCirculationEl, parseInt(totalCirculationEl.textContent), totalCirculation, 300);
            totalPeopleEl.textContent = students.length;
        }

        // 数字变化动画
        function animateValue(element, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                element.textContent = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // 保存数据到本地存储
        function saveData() {
            localStorage.setItem('libraryStudents', JSON.stringify(students));
        }

        // 处理增加书库班次数
        function handleLibraryIncrement(e) {
            e.stopPropagation();
            const index = parseInt(e.currentTarget.dataset.index);
            students[index].libraryDuty++;
            
            // 数字变化动画
            const countEl = e.currentTarget.previousElementSibling;
            countEl.classList.add('scale-125', 'font-bold');
            setTimeout(() => countEl.classList.remove('scale-125', 'font-bold'), 300);
            
            renderStudents();
        }

        // 处理增加流通班次数
        function handleCirculationIncrement(e) {
            e.stopPropagation();
            const index = parseInt(e.currentTarget.dataset.index);
            students[index].circulationDuty++;
            
            // 数字变化动画
            const countEl = e.currentTarget.previousElementSibling;
            countEl.classList.add('scale-125', 'font-bold');
            setTimeout(() => countEl.classList.remove('scale-125', 'font-bold'), 300);
            
            renderStudents();
        }

        // 处理班次清零
        function handleClearDuty(e) {
            e.stopPropagation();
            const index = parseInt(e.currentTarget.dataset.index);
            const dutyType = e.currentTarget.dataset.type; // 'library' 或 'circulation'
            
            // 二次确认（避免误操作）
            const dutyName = dutyType === 'library' ? '书库班' : '流通班';
            if (!confirm(`确定要清零${students[index].name}的${dutyName}次数吗？`)) {
                return;
            }
            
            // 清零对应班次
            if (dutyType === 'library') {
                students[index].libraryDuty = 0;
            } else {
                students[index].circulationDuty = 0;
            }
            
            // 清零动画反馈
            const countEl = e.currentTarget.parentElement.querySelector(`.${dutyType}-count`);
            countEl.classList.add('scale-90', 'text-clear');
            setTimeout(() => countEl.classList.remove('scale-90', 'text-clear'), 300);
            
            renderStudents();
        }

        // 处理删除学生
        function handleDelete(e) {
            e.stopPropagation();
            // 获取索引
            const index = parseInt(e.currentTarget.dataset.index);
            if (isNaN(index) || index < 0 || index >= students.length) {
                console.error('无效的学生索引:', index);
                return;
            }
            
            if (confirm(`确定要删除${students[index].name}的所有值班记录吗？`)) {
                // 获取学生元素
                const studentEl = e.currentTarget.closest('.student-item');
                if (studentEl) {
                    // 添加删除动画
                    studentEl.classList.add('opacity-0', 'scale-95', 'transition-all-300');
                }
                
                // 执行删除操作
                setTimeout(() => {
                    students.splice(index, 1);
                    renderStudents();
                }, 300);
            }
        }

        // 单个添加学生
        function addStudent() {
            const name = newPersonInput.value.trim();
            if (name) {
                // 检查是否已存在该学生
                const exists = students.some(student => student.name === name);
                if (exists) {
                    alert('该学生已存在！');
                    return;
                }
                
                // 新学生初始两种班次都是0次
                students.push({ 
                    name, 
                    libraryDuty: 0,  // 书库班次数
                    circulationDuty: 0  // 流通班次数
                });
                
                // 添加成功动画
                newPersonInput.value = '';
                newPersonInput.classList.add('border-green-500');
                setTimeout(() => newPersonInput.classList.remove('border-green-500'), 1000);
                
                renderStudents();
                newPersonInput.focus(); // 保持输入焦点
            } else {
                // 输入为空提示
                newPersonInput.classList.add('border-red-300');
                setTimeout(() => newPersonInput.classList.remove('border-red-300'), 1000);
                alert('请输入学生姓名！');
            }
        }

        // 批量导入学生（优化重复处理）
        function batchImportStudents() {
            const text = batchText.value.trim();
            if (!text) {
                showImportResult('请粘贴学生姓名后再导入', 'error');
                return;
            }
            
            // 1. 多种分隔符分割文本（逗号、换行、空格、分号）
            const nameArray = text
                .split(/[,，\n\r\s;；]+/)  // 支持中英文分隔符
                .map(name => name.trim()) // 去除每个姓名的前后空格
                .filter(name => name);    // 过滤空字符串
            
            // 2. 去除导入文本内部的重复名字
            const uniqueNamesInImport = [...new Set(nameArray)];
            
            if (uniqueNamesInImport.length === 0) {
                showImportResult('未识别到有效学生姓名，请检查格式', 'error');
                return;
            }
            
            // 3. 排除与系统中已有学生重复的名字
            const existingNames = new Set(students.map(student => student.name));
            const newNames = uniqueNamesInImport.filter(name => !existingNames.has(name));
            const duplicateNamesInSystem = uniqueNamesInImport.filter(name => existingNames.has(name));
            
            // 4. 统计导入文本内部的重复数量
            const duplicateCountInImport = nameArray.length - uniqueNamesInImport.length;
            const duplicateNamesInImport = [];
            if (duplicateCountInImport > 0) {
                // 找出导入文本中重复的名字
                const nameCount = {};
                nameArray.forEach(name => {
                    nameCount[name] = (nameCount[name] || 0) + 1;
                });
                // 收集重复的名字（出现次数 > 1的）
                for (const name in nameCount) {
                    if (nameCount[name] > 1) {
                        duplicateNamesInImport.push(`${name}（重复${nameCount[name]-1}次）`);
                    }
                }
            }
            
            // 5. 批量添加新学生
            if (newNames.length > 0) {
                const newStudents = newNames.map(name => ({
                    name,
                    libraryDuty: 0,
                    circulationDuty: 0
                }));
                students.push(...newStudents);
                
                // 保存并刷新列表
                saveData();
                renderStudents();
            }
            
            // 6. 显示导入结果（详细说明各类重复情况）
            let resultText = '';
            if (newNames.length > 0) {
                resultText += `成功导入 ${newNames.length} 名新学生：${newNames.join('、')}`;
            }
            if (duplicateNamesInSystem.length > 0) {
                resultText += `${newNames.length > 0 ? '，' : ''}系统中已存在 ${duplicateNamesInSystem.length} 名学生，未重复导入：${duplicateNamesInSystem.join('、')}`;
            }
            if (duplicateCountInImport > 0) {
                resultText += `${resultText ? '，' : ''}导入文本中存在 ${duplicateCountInImport} 个重复项，已自动去重：${duplicateNamesInImport.join('、')}`;
            }
            showImportResult(resultText, 'success');
            
            // 7. 3秒后自动关闭模态框
            setTimeout(() => {
                closeModal();
            }, 3000);
        }

        // 显示导入结果提示
        function showImportResult(text, type) {
            importResult.textContent = text;
            importResult.classList.remove('hidden', 'bg-green-50', 'text-green-700', 'bg-red-50', 'text-red-700');
            
            if (type === 'success') {
                importResult.classList.add('bg-green-50', 'text-green-700');
            } else if (type === 'error') {
                importResult.classList.add('bg-red-50', 'text-red-700');
            }
        }

        // 打开批量导入模态框
        function openModal() {
            batchImportModal.classList.remove('hidden');
            batchText.value = '';
            importResult.classList.add('hidden');
            batchText.focus(); // 自动聚焦到输入框
            // 禁止背景滚动
            document.body.style.overflow = 'hidden';
        }

        // 关闭批量导入模态框
        function closeModal() {
            batchImportModal.classList.add('hidden');
            // 恢复背景滚动
            document.body.style.overflow = '';
        }

        // 重置所有记录
        function resetAll() {
            if (students.length > 0 && confirm('确定要重置所有记录吗？这将清除所有学生及值班数据！')) {
                // 添加淡出动画
                const studentElements = document.querySelectorAll('.student-item');
                studentElements.forEach((el, i) => {
                    setTimeout(() => {
                        el.classList.add('opacity-0', 'scale-95');
                        if (i === studentElements.length - 1) {
                            setTimeout(() => {
                                students = [];
                                renderStudents();
                                // 隐藏汇总区域（如果显示）
                                if (!summaryArea.classList.contains('hidden')) {
                                    toggleSummary();
                                }
                            }, 300);
                        }
                    }, i * 100);
                });
            }
        }

        // 切换汇总区域显示/隐藏
        function toggleSummary() {
            if (students.length === 0) {
                alert('没有可显示的值班记录，请先添加学生并记录值班次数');
                return;
            }
            
            // 切换显示状态并添加动画
            if (summaryArea.classList.contains('hidden')) {
                summaryArea.classList.remove('hidden');
                summaryArea.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    summaryArea.classList.remove('opacity-0', 'scale-95');
                    summaryArea.classList.add('opacity-100', 'scale-100', 'transition-all-300');
                }, 10);
            } else {
                summaryArea.classList.remove('opacity-100', 'scale-100');
                summaryArea.classList.add('opacity-0', 'scale-95', 'transition-all-300');
                setTimeout(() => {
                    summaryArea.classList.add('hidden');
                }, 300);
            }
            
            // 显示时更新汇总内容
            if (!summaryArea.classList.contains('hidden')) {
                updateSummary();
                // 平滑滚动到汇总区域
                summaryArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // 更新汇总内容
        function updateSummary() {
            // 设置汇总日期
            const now = new Date();
            const formattedDate = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日 ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            summaryDate.textContent = `更新时间: ${formattedDate}`;
            
            // 填充汇总表格
            summaryTableBody.innerHTML = '';
            students.forEach((student, index) => {
                const total = student.libraryDuty + student.circulationDuty;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-all-300';
                row.innerHTML = `
                    <td class="py-4 px-6 whitespace-nowrap">${index + 1}</td>
                    <td class="py-4 px-6 whitespace-nowrap">${student.name}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-library">${student.libraryDuty}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-circulation">${student.circulationDuty}</td>
                    <td class="py-4 px-6 whitespace-nowrap font-medium">${total}</td>
                `;
                summaryTableBody.appendChild(row);
            });
            
            // 计算总计
            const totalLibrary = students.reduce((sum, student) => sum + student.libraryDuty, 0);
            const totalCirculation = students.reduce((sum, student) => sum + student.circulationDuty, 0);
            const totalAll = totalLibrary + totalCirculation;
            
            summaryTotalLibrary.textContent = totalLibrary;
            summaryTotalCirculation.textContent = totalCirculation;
            summaryTotalAll.textContent = totalAll;
        }

        // 初始化事件监听
        function initEventListeners() {
            // 单个添加
            addBtn.addEventListener('click', addStudent);
            newPersonInput.addEventListener('keypress', (e) => e.key === 'Enter' && addStudent());
            
            // 批量导入
            batchImportBtn.addEventListener('click', openModal);
            closeModalBtn.addEventListener('click', closeModal);
            cancelImportBtn.addEventListener('click', closeModal);
            confirmImportBtn.addEventListener('click', batchImportStudents);
            // 按Enter键确认导入
            batchText.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { // 不按Shift的Enter才触发（避免换行）
                    e.preventDefault();
                    batchImportStudents();
                }
            });
            // 点击模态框背景关闭
            batchImportModal.addEventListener('click', (e) => {
                if (e.target === batchImportModal) {
                    closeModal();
                }
            });
            
            // 其他功能
            resetBtn.addEventListener('click', resetAll);
            showSummaryBtn.addEventListener('click', toggleSummary);
        }

        // 初始执行
        initEventListeners();
        renderStudents();
    </script>
</body>
</html>
